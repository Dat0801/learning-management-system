<div class="course-page-wrapper" *ngIf="course; else loadingTpl">
  
  <!-- Top Dark Header Area -->
  <div class="course-hero-section">
    <div class="container">
      <div class="hero-content">
        <!-- Breadcrumbs -->
        <div class="breadcrumbs">
          <a routerLink="/">Home</a>
          <span class="separator">›</span>
          <a routerLink="/browse">Courses</a>
          <span class="separator">›</span>
          <span class="current">{{ course.title }}</span>
        </div>

        <h1>{{ course.title }}</h1>
        <p class="subtitle">{{ course.description }}</p>

        <div class="course-meta">
          <span class="badge bestseller" *ngIf="(course.rating || 0) >= 4.5">Bestseller</span>
          <span class="rating">
            <span class="score">{{ course.rating }}</span>
            <span class="stars">
              <i *ngFor="let star of [1,2,3,4,5]" class="fas fa-star" [class.filled]="star <= (course.rating || 0)"></i>
            </span>
            <span class="count">({{ course.rating_count | number }} ratings)</span>
          </span>
          <span class="students">{{ course.enrollments_count | number }} students</span>
        </div>

        <div class="created-by">
          Created by <a href="#" (click)="$event.preventDefault()">{{ course.instructor?.name || 'Instructor' }}</a>
        </div>

        <div class="last-updated">
          <span class="icon"><i class="fas fa-exclamation-circle"></i></span>
          Last updated {{ course.last_updated | date:'M/yyyy' }}
          <span class="lang"><i class="fas fa-globe"></i> {{ course.language }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area with Sidebar -->
  <div class="container course-body">
    <div class="grid-layout">
      
      <!-- Left Column: Main Content -->
      <div class="main-column">
        
        <!-- Navigation Tabs -->
        <div class="course-tabs">
          <button [class.active]="activeTab === 'about'" (click)="setActiveTab('about')">About</button>
          <button [class.active]="activeTab === 'syllabus'" (click)="setActiveTab('syllabus')">Syllabus</button>
          <button [class.active]="activeTab === 'instructor'" (click)="setActiveTab('instructor')">Instructor</button>
          <button [class.active]="activeTab === 'reviews'" (click)="setActiveTab('reviews')">Reviews</button>
        </div>

        <!-- What you'll learn -->
        <section class="what-you-learn" *ngIf="activeTab === 'about'">
          <h2>What you'll learn</h2>
          <div class="learning-points-grid">
            <div class="point" *ngFor="let point of whatYouWillLearn">
              <i class="fas fa-check"></i>
              <span>{{ point }}</span>
            </div>
          </div>
        </section>

        <!-- Course Content (Curriculum) -->
        <section class="course-content-section" id="syllabus" *ngIf="activeTab === 'about' || activeTab === 'syllabus'">
          <h2>Course Content</h2>
          <div class="content-stats">
            <span>{{ course.lessons?.length || 0 }} lectures</span> • <span>{{ course.duration || '10h 5m' }} total length</span>
          </div>
          
          <div class="curriculum-accordion">
            <!-- For now, we just list lessons. In a real app, these would be grouped by section -->
            <div class="section-item">
              <div class="section-header">
                <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
                <h3>Course Curriculum</h3>
                <span class="meta">{{ course.lessons?.length }} lectures</span>
              </div>
              <div class="section-body">
                <div class="lesson-row" *ngFor="let lesson of course.lessons" [class.locked]="!course.is_enrolled && !lesson.is_preview">
                  <div class="lesson-left">
                    <i class="fas fa-play-circle" *ngIf="!lesson.is_completed"></i>
                    <i class="fas fa-check-circle completed" *ngIf="lesson.is_completed"></i>
                    <span class="lesson-title">{{ lesson.title }}</span>
                  </div>
                  <div class="lesson-right">
                    <span class="preview-text" *ngIf="lesson.is_preview && !course.is_enrolled">Preview</span>
                    <span class="duration">05:20</span>
                  </div>
                  <a *ngIf="course.is_enrolled" 
                     [routerLink]="['/learning', course.id]" 
                     [queryParams]="{lesson: lesson.id}"
                     class="lesson-link-overlay"></a>
                  <a *ngIf="!course.is_enrolled && lesson.is_preview"
                     (click)="$event.preventDefault(); openPreview(lesson)"
                     href="#"
                     class="lesson-link-overlay"></a>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Description -->
        <section class="description-section" *ngIf="activeTab === 'about'">
          <h2>Description</h2>
          <div [innerHTML]="course.description"></div>
        </section>

        <!-- Instructor -->
        <section class="instructor-section" id="instructor" *ngIf="activeTab === 'about' || activeTab === 'instructor'">
          <h2>Instructor</h2>
          <div class="instructor-profile">
            <h3><a href="#">{{ course.instructor?.name }}</a></h3>
            <p class="instructor-title">{{ course.instructor?.headline }}</p>
            
            <div class="instructor-stats">
              <div class="stat">
                <div class="icon"><i class="fas fa-star"></i></div>
                <div class="text">{{ course.instructor?.average_rating }} Instructor Rating</div>
              </div>
              <div class="stat">
                <div class="icon"><i class="fas fa-medal"></i></div>
                <div class="text">{{ course.instructor?.students_count | number }} Students</div>
              </div>
              <div class="stat">
                <div class="icon"><i class="fas fa-play-circle"></i></div>
                <div class="text">{{ course.instructor?.courses_count }} Courses</div>
              </div>
            </div>
            
            <div class="instructor-bio">
              <p>{{ course.instructor?.bio }}</p>
            </div>
          </div>
        </section>

        <!-- Student Feedback -->
        <section class="feedback-section" id="reviews" *ngIf="activeTab === 'about' || activeTab === 'reviews'">
          <h2>Student Feedback</h2>
          <div class="feedback-grid">
            <div class="rating-summary">
              <div class="big-rating">{{ course.rating }}</div>
              <div class="stars">
                <i *ngFor="let star of [1,2,3,4,5]" class="fas fa-star" [class.filled]="star <= (course.rating || 0)"></i>
              </div>
              <div class="rating-text">Course Rating</div>
            </div>
            
            <div class="rating-bars">
              <div class="bar-row">
                <div class="progress-bar"><div class="fill" style="width: 70%"></div></div>
                <div class="stars-row">
                  <i *ngFor="let s of [1,2,3,4,5]" class="fas fa-star filled"></i>
                </div>
                <span class="percent">70%</span>
              </div>
              <div class="bar-row">
                <div class="progress-bar"><div class="fill" style="width: 22%"></div></div>
                <div class="stars-row">
                  <i *ngFor="let s of [1,2,3,4]" class="fas fa-star filled"></i><i class="fas fa-star"></i>
                </div>
                <span class="percent">22%</span>
              </div>
              <div class="bar-row">
                <div class="progress-bar"><div class="fill" style="width: 5%"></div></div>
                <div class="stars-row">
                  <i *ngFor="let s of [1,2,3]" class="fas fa-star filled"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                </div>
                <span class="percent">5%</span>
              </div>
              <!-- More bars... -->
            </div>
          </div>

          <!-- Reviews List -->
          <div class="reviews-list mt-8">
            <div *ngFor="let review of reviews" class="review-item">
              <div class="review-header">
                <div class="user-avatar">{{ review.user?.name?.charAt(0) || 'U' }}</div>
                <div class="user-info">
                  <div class="name">{{ review.user?.name || 'User' }}</div>
                  <div class="review-stars">
                    <i *ngFor="let s of [1,2,3,4,5]" class="fas fa-star" [class.filled]="s <= review.rating"></i>
                  </div>
                </div>
                <div class="time">{{ review.created_at | date }}</div>
              </div>
              <div class="review-content">{{ review.comment }}</div>
            </div>
          </div>
        </section>

      </div>

      <!-- Right Column: Sidebar (Sticky) -->
      <div class="sidebar-column">
        <div class="sidebar-content">
          <!-- Video Preview -->
          <div class="preview-card">
            <div class="video-thumbnail" (click)="openPreview()">
              <div class="play-overlay">
                <div class="play-icon"><i class="fas fa-play"></i></div>
                <span>Preview this course</span>
              </div>
              <!-- Placeholder image -->
              <div class="thumbnail-placeholder"></div> 
            </div>
            
            <div class="sidebar-body">
              <div class="price-area" *ngIf="!course.is_enrolled">
                <div class="current-price">${{ course.price }}</div>
                <div class="original-price" *ngIf="course.price > 0">${{ course.price * 1.5 | number:'1.2-2' }}</div>
                <div class="discount" *ngIf="course.price > 0">43% OFF</div>
              </div>

              <div class="action-buttons">
                <ng-container *ngIf="!course.is_enrolled">
                  <button class="btn-add-cart" (click)="enroll()">Add to Cart</button>
                  <button class="btn-buy-now" (click)="enroll()">Buy Now</button>
                </ng-container>
                
                <ng-container *ngIf="course.is_enrolled">
                  <button class="btn-buy-now" [routerLink]="['/learning', course.id]">Go to Course</button>
                </ng-container>

                <div class="guarantee">30-Day Money-Back Guarantee</div>
              </div>

              <div class="includes-list">
                <h4>This course includes:</h4>
                <ul>
                  <li *ngFor="let item of courseIncludes">
                    <i [class]="item.icon"></i>
                    <span>{{ item.text }}</span>
                  </li>
                </ul>
              </div>

              <div class="sidebar-footer">
                <button class="btn-text">Share</button>
                <button class="btn-text" (click)="toggleWishlist()">
                  {{ isInWishlist ? 'Wishlisted ❤️' : 'Wishlist' }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>Loading course details...</p>
  </div>
</ng-template>

<!-- Preview Modal -->
<div class="video-modal-overlay" *ngIf="showPreviewModal" (click)="closePreview()">
  <div class="video-modal-content" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closePreview()"><i class="fas fa-times"></i></button>
    <div class="video-wrapper">
      <iframe *ngIf="previewVideoUrl" [src]="previewVideoUrl" frameborder="0" allowfullscreen allow="autoplay"></iframe>
    </div>
  </div>
</div>